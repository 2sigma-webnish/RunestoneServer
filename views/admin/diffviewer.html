{{extend 'layout.html'}}

<script src="/{{=request.application}}/static/{{=course_id}}/_static/skulpt.js" type="text/javascript"></script>
<script src="/{{=request.application}}/static/{{=course_id}}/_static/builtin.js" type="text/javascript"></script>

<script type="text/javascript" charset="utf-8">
getDiffs = function() {
    $.get("/runestone/ajax/getCodeDiffs", function(data) {
        diffdata = JSON.parse(data)
        diffcount = 0
        nextDiff();
    })
}

nextDiff = function() {
    var myDiv = document.getElementById("codeviewer");
    
    myDiv.innerHTML = diffdata.diffs[diffcount];
    $("#tstamp").html(diffdata.timestamps[diffcount]);

    diffcount = diffcount + 1;
    

}

prevDiff = function() {
    var myDiv = document.getElementById("codeviewer");

    diffcount = diffcount - 1;    
    myDiv.innerHTML = diffdata.diffs[diffcount]
    $("#tstamp").html(diffdata.timestamps[diffcount]);    
}

function outf(text) {
    var mypre = document.getElementById(Sk.pre);
    // bnm python 3
    x = text;
    if (x.charAt(0) == '(') {
        x = x.slice(1, -1);
        x = '[' + x + ']';
        try {
            var xl = eval(x);
            xl = xl.map(pyStr);
            x = xl.join(' ');
        } catch (err) {
        }
    }
    text = x;
    text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br/>");
    mypre.innerHTML = mypre.innerHTML + text;
}

function builtinRead(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
        throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
}


function diffRunner(myDiv, theButton, prog) {
    //var prog = document.getElementById(myDiv + "_code").value;

    Sk.divid = myDiv;
    $(theButton).attr('disabled', 'disabled');
    Sk.isTurtleProgram = false;
    if (theButton !== undefined) {
        Sk.runButton = theButton;
    }
    $("#" + myDiv + "_errinfo").remove();

    var mypre = document.getElementById(myDiv + "_pre");
    if (mypre) mypre.innerHTML = '';
    Sk.canvas = myDiv + "_canvas";
    Sk.pre = myDiv + "_pre";
    var can = document.getElementById(Sk.canvas);
    // The following lines reset the canvas so that each time the run button
    // is pressed the turtle(s) get a clean canvas.
    if (can) {
        can.width = can.width;
        if (Sk.tg) {
            Sk.tg.canvasInit = false;
            Sk.tg.turtleList = [];
        }
    }
    // set execLimit in milliseconds  -- for student projects set this to
    // 25 seconds -- just less than Chrome's own timer.
    Sk.execLimit = 25000;
    // configure Skulpt output function, and module reader
    Sk.configure({output: outf,
                     read: builtinRead,
                     python3: true
                 });

    try {
        Sk.importMainWithBody("<stdin>", false, prog);
    } catch (e) {
        logRunEvent({'div_id': myDiv, 'code': prog, 'errinfo': e.toString()}); // Log the run event
        //alert(e);
        addErrorMessage(e, myDiv)
    }
    if (!Sk.isTurtleProgram) {
        $(theButton).removeAttr('disabled');
    }
    if (typeof(allVisualizers) != "undefined") {
        $.each(allVisualizers, function (i, e) {
            e.redrawConnectors();
        });
    }
}


</script>

<h1>Hello World</h1>

<label for="studentid">StudentId</label><input type="text" name="studentid" value="opdajo01" id="studentid">
<label for="exerciseid">exerciseId</label><input type="text" name="exerciseid" value="ex_3_10" id="exerciseid">

<button onclick="getDiffs()">Fetch</button>

<h3 id="tstamp"></h3>
<div id="codeviewer_div">
<pre id="codeviewer">    
</pre>
</div>
<button onclick="prevDiff()">Previous</button>
<button onclick="nextDiff()">Next</button>
<button onclick="diffRunner('runner',self,diffdata.code[diffcount]);">Run</button>

<div id="runner">
    <pre id="runner_pre"></pre>
    <canvas id="runner_canvas" height="400px" width="400px"></canvas>
    <p id="runner_errinfo"></p>
</div>
